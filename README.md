# Log Analyzer

Log Analyzer — это инструмент для анализа логов веб-сервера nginx, который извлекает важную информацию из файлов логов и генерирует отчеты.  
Проект поддерживает обработку как plain логов (т.е. "сырые" без сжатия), так и в формате .gz  
Скрипт рассчитывает различные метрики (например, количество запросов, среднее время запроса, медиану, максимальное время и т.д.) и генерирует HTML отчет с данными по самым медленным URL.  

## Основная функциональность

1. **Обработка логов**: Скрипт анализирует последний лог-файл в директории, выбирая файл с самой свежей датой. Он парсит логи, извлекает данные о запросах, рассчитывает статистику по URL и генерирует HTML-отчет.  


2. **Конфигурация**: Можно указать путь к конфигурационному файлу через аргумент `--config`. Если файл не существует или его нельзя прочитать, скрипт завершит работу с ошибкой. Конфигурация сливается с дефолтной, а настройки из файла имеют приоритет.


3. **Вывод отчетов**: В отчет попадают URL с наибольшим временем обработки, сортированные по суммарному времени обработки (`time_sum`). Отчет сохраняется в формате `report-YYYY.MM.DD.html`.


4. **Тестирование**: Для проверки логики работы написаны тесты с использованием `pytest`.

## Установка

1. Клонируйте репозиторий:

    ```bash
    git clone https://github.com/artyombn/log_analyzer.git
    ```

2. Установите зависимости с помощью `poetry`:

    ```bash
    poetry install
    ```

## Запуск

### Без Docker

Для запуска без Docker:

1. Убедитесь, что у вас есть доступ к логам и конфигурационному файлу, затем используйте команду:

    ```bash
    python -m log_analyzer.py --config /path/to/config.json
    ```

Где `/path/to/config.json` — это путь к конфигу на вашей машине.

### С использованием Docker

Если вы хотите запустить проект с использованием Docker, выполните следующие шаги:

1. Создайте образ Docker:

    ```bash
    docker build -t log_analyzer .
    ```

2. Запустите контейнеры:

    ```bash
    docker-compose up -d
    ```

Вы можете настроить пути для logs, config и reports на своей локальной машине, отредактировав файл `docker-compose.yml`. 

Для этого нужно изменить параметры монтирования в секции сервиса `log_analyzer`:

```yaml
log_analyzer:
  volumes:
    - ./logs:/app/logs        # Локальная папка с логами
    - ./src/config:/app/config # Локальная папка с конфигурацией
    - ./reports:/app/reports  # Локальная папка для сохранения отчетов
```


### Пример конфигурационного файла

```json
{
  "REPORT_SIZE": 10,
  "REPORT_DIR": "/path/to/reports",
  "LOG_DIR": "/path/to/logs"
}
```

### Пример отчета

После выполнения скрипта, отчет будет сохранен в директории, указанной в конфиге, в файле вида `report-YYYY.MM.DD.html`.

Пример отчета:

| URL                       | count | count_perc | time_avg                                | time_max | time_med | time_perc | time_sum |
|---------------------------|-------|------------|-----------------------------------------|----------|----------|-----------|--|
| `/api/v2/internal/html5/phantomjs/queue/?wait=1m`                 | 2767  | 0.106      | <span style="color: red;">62.995</span> | 9843.569 | 60.073   | 9.043     | 174306.352|
| `/api/v2/internal/gpmd_plan_report/queue/?wait=1m&worker=5`            | 1410  | 0.054      | <span style="color: red;">67.106</span>                                  | 9853.373 | 60.124   | 4.909     | 94618.864 |
| `/api/v2/internal/gpmd_plan_report/queue/?wait=1m&worker=2`               | 1409  | 0.054      | <span style="color: red;">67.096</span>                                  | 9826.572 | 60.125   | 4.905     | 94537.857 |
| `/api/v2/internal/gpmd_plan_report/queue/?wait=1m&worker=3`                   | 1393  | 0.053      | <span style="color: red;">67.189</span>                                  | 9853.242 | 60.125   | 4.856     | 93594.358 |
| `/api/v2/internal/gpmd_plan_report/queue/?wait=1m&worker=4`                  | 1392  | 0.053      | <span style="color: red;">67.133</span>                                  | 9826.209 | 60.124   | 4.848     | 93448.983 |

- **count** — количество запросов для данного URL.
- **count_perc** — процент от общего числа запросов.
- **time_sum** — суммарное время обработки запросов для данного URL.
- **time_perc** — процент от общего времени всех запросов.
- **time_avg** — среднее время запроса.
- **time_max** — максимальное время запроса.
- **time_med** — медианное время запроса.


# Инструкция по запуску линтеров и тестов через Make

В проекте настроены команды для запуска литеров и тестов с помощью утилиты `make`.

## 1. Запуск линтеров

Для того чтобы запустить линтеры (black, isort, pylint и mypy), выполните команду:

```bash
make startlinters
```

Команда выполнит следующие шаги:
- Применит форматирование с помощью `black`.
- Организует импорты с помощью `isort`.
- Проверит код с помощью `pylint`.
- Проверит типы с помощью `mypy`.

## 2. Запуск тестов

Для запуска тестов с использованием `pytest`, выполните команду:

```bash
make startpytest
```

Команда выполнит запуск тестов через `pytest` и выведет результаты выполнения тестов, включая количество пройденных и неудачных тестов.
### Примечания

- Убедитесь, что у вас установлена утилита командной строки make ```sudo apt install make```
- Убедитесь, что вы находитесь в корневой директории проекта, где расположен файл `Makefile`.
- Если вы хотите настроить параметры линтеров или тестов, отредактируйте соответствующие строки в `Makefile`.
```